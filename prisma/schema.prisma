generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model School {
  id               String   @id @default(cuid())
  name             String   @default("")
  academicYear     Int      @default(2025)
  // 学年別学級数 (JSON: {"1": 4, "2": 4, "3": 4})
  classCountsJson  String   @default("{}")
  // 命名規則: "number" (1組,2組...) or "alphabet" (A組,B組...)
  namingConvention String   @default("number")
  // 週制: 5 or 6
  daysPerWeek      Int      @default(5)
  // 1日の最大コマ数
  maxPeriodsPerDay Int      @default(6)
  // 0時限目の有無
  hasZeroPeriod    Boolean  @default(false)
  // 時間帯名称 (JSON array)
  periodNamesJson  String   @default("[]")
  // 帯長(分) (JSON array)
  periodLengthsJson String  @default("[]")
  // 昼休み位置（何時限目の後）
  lunchAfterPeriod Int      @default(4)
  // 無効スロット (JSON: [{"dayOfWeek":4,"period":6}])
  disabledSlotsJson String  @default("[]")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Grade {
  id        String   @id @default(cuid())
  gradeNum  Int      @unique
  name      String   // "1年", "2年", "3年"
  classes   Class[]
  komas     Koma[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Class {
  id          String       @id @default(cuid())
  gradeId     String
  grade       Grade        @relation(fields: [gradeId], references: [id], onDelete: Cascade)
  name        String       // "1組", "2組" or "A組", "B組"
  sortOrder   Int          @default(0)
  komaClasses KomaClass[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([gradeId, name])
  @@index([gradeId])
}

model Teacher {
  id             String               @id @default(cuid())
  name           String
  nameKana       String               @default("")
  // 担当教科ID (メイン)
  mainSubjectId  String?
  // 連続授業の最大数
  maxConsecutive Int                   @default(6)
  // 1日の最大授業数
  maxPerDay      Int                   @default(6)
  // 週当たり最大コマ数
  maxPeriodsPerWeek Int               @default(25)
  // 備考
  notes          String               @default("")
  availabilities TeacherAvailability[]
  teacherDuties  TeacherDuty[]
  komaTeachers   KomaTeacher[]
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
}

model TeacherAvailability {
  id         String  @id @default(cuid())
  teacherId  String
  teacher    Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  dayOfWeek  Int     // 0=月, 1=火, 2=水, 3=木, 4=金, (5=土)
  period     Int     // 1〜6 (0=0時限目)
  // "available" | "unavailable" | "preferred"
  status     String  @default("available")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([teacherId, dayOfWeek, period])
  @@index([teacherId])
}

model Subject {
  id           String   @id @default(cuid())
  name         String   @unique
  shortName    String   @default("")
  color        String   @default("#6B7280")
  // "general" | "reserve" | "school_affair"
  category     String   @default("general")
  sortOrder    Int      @default(0)
  isDefault    Boolean  @default(false)
  komas        Koma[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model SpecialRoom {
  id             String             @id @default(cuid())
  name           String
  shortName      String             @default("")
  // 収容可能人数
  capacity       Int                @default(40)
  notes          String             @default("")
  sortOrder      Int                @default(0)
  availabilities RoomAvailability[]
  komaRooms      KomaRoom[]
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
}

model RoomAvailability {
  id        String      @id @default(cuid())
  roomId    String
  room      SpecialRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  dayOfWeek Int         // 0=月, 1=火, 2=水, 3=木, 4=金, (5=土)
  period    Int         // 1〜6 (0=0時限目)
  // "available" | "unavailable"
  status    String      @default("available")
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@unique([roomId, dayOfWeek, period])
  @@index([roomId])
}

model Duty {
  id           String        @id @default(cuid())
  name         String
  shortName    String        @default("")
  dayOfWeek    Int           // 0=月, 1=火, 2=水, 3=木, 4=金, (5=土)
  period       Int           // 時限
  sortOrder    Int           @default(0)
  teacherDuties TeacherDuty[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model TeacherDuty {
  id        String   @id @default(cuid())
  dutyId    String
  duty      Duty     @relation(fields: [dutyId], references: [id], onDelete: Cascade)
  teacherId String
  teacher   Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([dutyId, teacherId])
  @@index([dutyId])
  @@index([teacherId])
}

model Koma {
  id           String        @id @default(cuid())
  subjectId    String
  subject      Subject       @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  gradeId      String
  grade        Grade         @relation(fields: [gradeId], references: [id], onDelete: Cascade)
  // "normal" | "consecutive"
  type         String        @default("normal")
  // 週あたり駒数
  count        Int           @default(1)
  // 優先順位 (0-9, 高いほど優先)
  priority     Int           @default(5)
  label        String        @default("")
  komaTeachers KomaTeacher[]
  komaClasses  KomaClass[]
  komaRooms    KomaRoom[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([subjectId])
  @@index([gradeId])
}

model KomaTeacher {
  id        String   @id @default(cuid())
  komaId    String
  koma      Koma     @relation(fields: [komaId], references: [id], onDelete: Cascade)
  teacherId String
  teacher   Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  // "main" | "sub"
  role      String   @default("main")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([komaId, teacherId])
  @@index([komaId])
  @@index([teacherId])
}

model KomaClass {
  id        String   @id @default(cuid())
  komaId    String
  koma      Koma     @relation(fields: [komaId], references: [id], onDelete: Cascade)
  classId   String
  class_    Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([komaId, classId])
  @@index([komaId])
  @@index([classId])
}

model KomaRoom {
  id        String      @id @default(cuid())
  komaId    String
  koma      Koma        @relation(fields: [komaId], references: [id], onDelete: Cascade)
  roomId    String
  room      SpecialRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@unique([komaId, roomId])
  @@index([komaId])
  @@index([roomId])
}

// ========== Phase 3: 時間割作成 ==========

model ScheduleCondition {
  id                        String               @id @default(cuid())
  // 制約レベル: "forbidden" | "consider" | "ignore" | "manual_only"
  // --- 先生制約 ---
  teacherAvailability       String               @default("forbidden")  // 先生の都合
  teacherAvailabilityWeight Int                  @default(100)
  teacherMaxPerDay          String               @default("consider")   // 先生1日の最大コマ数
  teacherMaxPerDayWeight    Int                  @default(80)
  teacherMaxConsecutive     String               @default("consider")   // 先生の連続授業
  teacherMaxConsecutiveWeight Int                @default(80)
  teacherMaxPerWeek         String               @default("consider")   // 先生週あたり最大
  teacherMaxPerWeekWeight   Int                  @default(60)
  // --- クラス制約 ---
  classSameSubjectPerDay    String               @default("consider")   // クラス同一教科1日制限
  classSameSubjectPerDayWeight Int               @default(70)
  classConsecutiveSame      String               @default("ignore")     // クラス同一教科連続不可
  classConsecutiveSameWeight Int                 @default(50)
  // --- 教室制約 ---
  roomConflict              String               @default("forbidden")  // 教室重複禁止
  roomConflictWeight        Int                  @default(100)
  roomAvailability          String               @default("forbidden")  // 教室利用可能時間
  roomAvailabilityWeight    Int                  @default(100)
  // --- 校務制約 ---
  dutyConflict              String               @default("forbidden")  // 校務時間帯不可
  dutyConflictWeight        Int                  @default(100)
  // --- 連続駒制約 ---
  consecutiveKoma           String               @default("consider")   // 連続駒は隣接配置
  consecutiveKomaWeight     Int                  @default(90)
  // --- バランス制約 ---
  dailyBalance              String               @default("consider")   // 曜日間コマ数均等化
  dailyBalanceWeight        Int                  @default(40)
  // --- 教科別制約 ---
  perSubjectConditions      PerSubjectCondition[]
  createdAt                 DateTime             @default(now())
  updatedAt                 DateTime             @updatedAt
}

model PerSubjectCondition {
  id                   String            @id @default(cuid())
  conditionId          String
  condition            ScheduleCondition @relation(fields: [conditionId], references: [id], onDelete: Cascade)
  subjectId            String
  // 制約レベル: "forbidden" | "consider" | "ignore"
  level                String            @default("consider")
  // 教科別の配置制限: "any" | "morning_only" | "afternoon_only" | "not_first" | "not_last"
  placementRestriction String            @default("any")
  // 最大連続禁止
  maxPerDay            Int               @default(2)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  @@unique([conditionId, subjectId])
  @@index([conditionId])
}

model TimetablePattern {
  id             String          @id @default(cuid())
  name           String          @default("")
  // "draft" | "candidate" | "adopted"
  status         String          @default("draft")
  // 違反数 (キャッシュ)
  violationCount Int             @default(0)
  // スコア (低いほど良い)
  score          Float           @default(0)
  // メタデータ (JSON: ソルバー設定等)
  metadataJson   String          @default("{}")
  slots          TimetableSlot[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model TimetableSlot {
  id          String           @id @default(cuid())
  patternId   String
  pattern     TimetablePattern @relation(fields: [patternId], references: [id], onDelete: Cascade)
  komaId      String
  dayOfWeek   Int              // 0=月, 1=火, 2=水, 3=木, 4=金, (5=土)
  period      Int              // 時限
  // "auto" | "manual" | "fixed"
  placedBy    String           @default("auto")
  isFixed     Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@unique([patternId, komaId, dayOfWeek, period])
  @@index([patternId])
  @@index([komaId])
  @@index([patternId, dayOfWeek, period])
}

// ========== Phase 5: 日課管理・運用支援 ==========

model DailySchedule {
  id            String        @id @default(cuid())
  date          String        // "YYYY-MM-DD"
  // "normal" | "shortened" | "exam" | "event" | "holiday" | "custom"
  scheduleType  String        @default("normal")
  // 実施コマ数 (省略時は学校設定値)
  periodsCount  Int?
  reason        String        @default("")
  notes         String        @default("")
  changes       DailyChange[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@unique([date])
}

model DailyChange {
  id               String        @id @default(cuid())
  dailyScheduleId  String
  dailySchedule    DailySchedule @relation(fields: [dailyScheduleId], references: [id], onDelete: Cascade)
  classId          String
  period           Int
  // "cancel" | "substitute" | "swap" | "special" | "self_study"
  changeType       String
  // 元の駒ID (参照用、FK不要)
  originalKomaId   String?
  // 代替先生ID
  substituteTeacherId String?
  // 振替先日付 "YYYY-MM-DD"
  rescheduleDate   String?
  // 振替先時限
  reschedulePeriod Int?
  // 備考
  notes            String        @default("")
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@unique([dailyScheduleId, classId, period])
  @@index([dailyScheduleId])
  @@index([classId])
}

model SchoolEvent {
  id         String   @id @default(cuid())
  date       String   // "YYYY-MM-DD"
  // "holiday" | "national_holiday" | "school_event" | "exam" | "ceremony" | "other"
  eventType  String
  name       String
  // 終日かどうか
  isAllDay   Boolean  @default(true)
  // 影響するコマ数 (0=全コマ休止)
  affectedPeriods Int @default(0)
  notes      String   @default("")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([date])
  @@index([eventType])
}

// ========== Phase 6: 拡張機能 ==========

model ExamSchedule {
  id           String           @id @default(cuid())
  name         String           // "1学期中間テスト" 等
  startDate    String           // "YYYY-MM-DD"
  endDate      String           // "YYYY-MM-DD"
  // 科目リスト (JSON: ["数学","英語",...])
  subjectsJson String           @default("[]")
  notes        String           @default("")
  assignments  ExamAssignment[]
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
}

model ExamAssignment {
  id             String       @id @default(cuid())
  examScheduleId String
  examSchedule   ExamSchedule @relation(fields: [examScheduleId], references: [id], onDelete: Cascade)
  date           String       // "YYYY-MM-DD"
  period         Int
  subjectId      String
  classId        String
  // 監督教員ID
  supervisorId   String
  // "auto" | "manual"
  assignedBy     String       @default("auto")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([examScheduleId, date, period, classId])
  @@index([examScheduleId])
  @@index([supervisorId])
}

model AppSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
